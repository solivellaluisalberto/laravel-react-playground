image: alberto1199/php83-cli-node24

definitions:
  caches:
    composer: vendor
    node: node_modules

  steps:
    - step: &install-dependencies
        name: ğŸ“¦ Instalar Dependencias
        caches:
          - composer
          - node
        script:
          # Copiar archivo de entorno
          - cp .env.example .env

          # Instalar dependencias de Composer
          - composer install --no-interaction --prefer-dist --optimize-autoloader

          # Generar key de aplicaciÃ³n
          - php artisan key:generate

          # Instalar dependencias de NPM
          - npm ci

        artifacts:
          - vendor/**
          - node_modules/**
          - .env

    - step: &code-style-php
        name: ğŸ¨ PHP - Verificar Estilo de CÃ³digo (Pint)
        caches:
          - composer
        script:
          # Ejecutar Pint en modo test (no modifica archivos)
          - ./vendor/bin/pint --test

    - step: &code-style-js
        name: ğŸ¨ JavaScript - Verificar Estilo de CÃ³digo
        caches:
          - node
        script:
          # Verificar formato con Prettier
          - npm run format:check

    - step: &run-tests
        name: ğŸ§ª Ejecutar Tests (PHPUnit)
        caches:
          - composer
        script:
          # Ejecutar tests con SQLite
          - php artisan test

    - step: &build-assets
        name: ğŸ—ï¸ Compilar Assets Frontend
        caches:
          - node
        script:
          # Compilar assets de producciÃ³n
          - npm run build
        artifacts:
          - public/build/**

pipelines:
  default:
    - step: *install-dependencies
    - parallel:
        - step: *code-style-php
        - step: *code-style-js
    - step: *run-tests
    - step: *build-assets

  branches:
    main:
      - step: *install-dependencies
      - parallel:
          - step: *code-style-php
          - step: *code-style-js
      - step: *run-tests
      - step: *build-assets
      - step:
          name: ğŸš€ Deploy a ProducciÃ³n
          deployment: production
          script:
            - echo "AquÃ­ irÃ­an los comandos de deploy"
            # - ssh user@server 'cd /var/www && git pull && composer install --no-dev && php artisan migrate --force && npm run build'

    develop:
      - step: *install-dependencies
      - parallel:
          - step: *code-style-php
          - step: *code-style-js
      - step: *run-tests
      - step: *build-assets
      - step:
          name: ğŸ”§ Deploy a Staging
          deployment: staging
          script:
            - echo "AquÃ­ irÃ­an los comandos de deploy a staging"

  pull-requests:
    '**':
      - step: *install-dependencies
      - parallel:
          - step: *code-style-php
          - step: *code-style-js
      - step: *run-tests
